{% extends "base.html" %}
{% block content %}
<div class="container mx-auto p-4 diagnosis-bg rounded-lg shadow-xl">
    <div class="flex items-center mb-6">
        <img src="{{ url_for('static', filename='icons8-chaff-48.png') }}" alt="Logo" class="h-16 w-16 mr-4 rounded-full">
        <div>
            <h1 class="text-3xl font-bold help-title">Crop Disease Diagnosis Guide</h1>
            <p class="text-lg help-text">Comprehensive user manual and troubleshooting guide</p>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="mb-6 flex items-center">
        <input type="text" id="helpSearch" placeholder="Search the guide..." class="input-field flex-grow p-3 rounded-md border mr-2">
        <button id="searchBtn" class="btn-primary px-4 py-2 rounded-md">Search</button>
    </div>

    <!-- Table of Contents -->
    <div class="card p-4 mb-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-3 section-title">Table of Contents</h2>
        <ul id="tocList" class="list-none space-y-2">
            <!-- TOC links will be dynamically generated by JS -->
        </ul>
    </div>

    <!-- Help Sections -->
    <div id="helpContent" class="space-y-6">
        <!-- Sections will be dynamically generated by JS -->
    </div>

    <!-- Bottom Buttons -->
    <div class="flex justify-between items-center mt-8">
        <a href="/" class="btn-primary px-6 py-2 rounded-md">← Back to Home</a>
        <button id="printGuideBtn" class="btn-primary px-6 py-2 rounded-md">Print This Guide</button>
    </div>
</div>

<script>
    const helpSearchInput = document.getElementById('helpSearch');
    const searchBtn = document.getElementById('searchBtn');
    const tocList = document.getElementById('tocList');
    const helpContentDiv = document.getElementById('helpContent');
    const printGuideBtn = document.getElementById('printGuideBtn');

    const helpSectionsData = [
        {
            "title": "Getting Started",
            "content": [
                {"subtitle": "Welcome to Crop Disease Diagnosis", "text": "This AI-powered application helps farmers and agricultural professionals identify diseases in crop leaves through image analysis."},
                {"subtitle": "System Requirements", "text": "• Modern web browser\n• Internet connection\n• Sufficient device storage for image uploads\n• Webcam or camera for live capture (browser support dependent)"},
                {"subtitle": "First Time Setup", "text": "1. Ensure your browser is up-to-date.\n2. No specific software installation is required for the web app.\n3. Make sure you have a stable internet connection."}
            ],
            "expanded": true
        },
        {
            "title": "Image Capture Guidelines",
            "content": [
                {"subtitle": "Optimal Image Quality", "text": "• Capture in well-lit conditions\n• Focus on the leaf surface\n• Include both healthy and affected areas\n• Avoid shadows and glare"},
                {"subtitle": "Recommended Practices", "text": "- Place leaf on neutral background\n- Include scale reference if possible\n- Capture multiple angles for severe cases"},
                {"subtitle": "Common Mistakes", "text": "× Blurry or out-of-focus images\n× Images with multiple leaves\n× Extreme close-ups without context\n× Poor lighting conditions"}
            ],
            "expanded": true
        },
        {
            "title": "Diagnosis Process",
            "content": [
                {"subtitle": "Step-by-Step Guide", "text": "1. Navigate to Diagnosis page.\n2. Upload an image or use your device's camera to capture one.\n3. Adjust image using enhancement tools if needed.\n4. View the diagnosis results, including confidence score and details.\n5. Save or print the comprehensive report."},
                {"subtitle": "Understanding Results", "text": "• Confidence scores indicate prediction reliability.\n• Multiple results may appear for similar diseases.\n• Low confidence suggests retaking the image with better quality."},
                {"subtitle": "Troubleshooting Diagnosis", "text": "If you get poor results:\n- Try different image adjustments.\n- Capture a clearer image.\n- Ensure the image is of a single crop leaf."}
            ],
            "expanded": false
        },
        {
            "title": "Advanced Features",
            "content": [
                {"subtitle": "Image Enhancement Tools", "text": "• Brightness/Contrast adjustment\n• Color saturation controls\n• Sharpening filters\n• Cropping functionality\n• Auto-contrast and grayscale presets"},
                {"subtitle": "History Management", "text": "• View past diagnoses.\n• Filter by date/crop type.\n• Export complete history to JSON.\n• Import history from JSON.\n• Re-diagnose or view image from history."},
                {"subtitle": "Feedback System", "text": "• Submit suggestions, bug reports, or feature requests.\n• Optionally attach screenshots.\n• Rate your overall experience."}
            ],
            "expanded": false
        },
        {
            "title": "Troubleshooting",
            "content": [
                {"subtitle": "Common Issues", "text": "• Image upload failed: Check file size and format.\n• Slow performance: Ensure a stable internet connection; large images take longer.\n• Incorrect results: Verify image quality and ensure it's a single crop leaf."},
                {"subtitle": "Error Messages", "text": "- 'Invalid image': Try a different format (JPG, PNG, BMP).\n- 'Low confidence': Retake image with better lighting/focus.\n- 'Server error': Contact support or try again later."},
                {"subtitle": "FAQ", "text": "Q: Can I use this for any crop?\nA: Currently supports 15 major crops (see full list in About page).\n\nQ: How accurate are the results?\nA: Accuracy depends on image quality and model training data. Average accuracy is high in controlled conditions."}
            ],
            "expanded": false
        },
        {
            "title": "Support & Resources",
            "content": [
                {"subtitle": "Contact Information", "text": "• Email: support@cropdiagnosis.com (placeholder)\n• For real support, use the Feedback page or check our official website (if available)."},
                {"subtitle": "Additional Resources", "text": "- Video tutorials (if available)\n- Community forums (if available)\n- External agricultural resources."},
                {"subtitle": "Feedback", "text": "We value your input! Please report any issues or suggestions through the dedicated Feedback page in the navigation menu."}
            ],
            "expanded": false
        }
    ];

    function buildHelpContent() {
        tocList.innerHTML = '';
        helpContentDiv.innerHTML = '';

        helpSectionsData.forEach((section, index) => {
            // Create TOC Link
            const tocItem = document.createElement('li');
            const tocLink = document.createElement('a');
            tocLink.href = `#section-${index}`;
            tocLink.textContent = `${index + 1}. ${section.title}`;
            tocLink.classList.add('text-lg', 'text-gray-700', 'dark:text-gray-300', 'hover:text-primary', 'transition-colors', 'duration-300', 'cursor-pointer', 'underline');
            tocLink.onclick = (e) => {
                e.preventDefault();
                document.getElementById(`section-${index}`).scrollIntoView({ behavior: 'smooth' });
                // Expand the section if it's collapsed
                if (!section.expanded) {
                    toggleSection(section, document.getElementById(`section-${index}`));
                }
                showNotification(`Scrolled to: ${section.title}`, "info");
            };
            tocItem.appendChild(tocLink);
            tocList.appendChild(tocItem);

            // Create Section Content
            const sectionDiv = document.createElement('div');
            sectionDiv.id = `section-${index}`;
            sectionDiv.classList.add('card', 'p-4', 'rounded-lg', 'shadow-md');

            const headerDiv = document.createElement('div');
            headerDiv.classList.add('flex', 'items-center', 'mb-3');

            const toggleBtn = document.createElement('button');
            toggleBtn.classList.add('px-2', 'py-1', 'rounded-md', 'btn-primary', 'text-lg', 'mr-3');
            toggleBtn.textContent = section.expanded ? '-' : '+';
            toggleBtn.onclick = () => toggleSection(section, sectionDiv);
            headerDiv.appendChild(toggleBtn);

            const titleH2 = document.createElement('h2');
            titleH2.classList.add('text-xl', 'font-semibold', 'help-text');
            titleH2.textContent = section.title;
            headerDiv.appendChild(titleH2);
            sectionDiv.appendChild(headerDiv);

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('space-y-4', 'pl-8');
            if (!section.expanded) {
                contentDiv.classList.add('hidden');
            }

            section.content.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.innerHTML = `<h3 class="font-medium text-lg help-text">${item.subtitle}</h3><p class="text-gray-700 dark:text-gray-300 whitespace-pre-line">${item.text}</p>`;
                contentDiv.appendChild(itemDiv);
            });
            sectionDiv.appendChild(contentDiv);
            helpContentDiv.appendChild(sectionDiv);

            // Store references for later use (e.g., search)
            section.element = sectionDiv;
            section.contentElement = contentDiv;
            section.toggleBtn = toggleBtn;
        });
    }

    function toggleSection(section, sectionElement) {
        section.expanded = !section.expanded;
        const contentDiv = section.contentElement;
        const toggleBtn = section.toggleBtn;

        if (section.expanded) {
            contentDiv.classList.remove('hidden');
            toggleBtn.textContent = '-';
        } else {
            contentDiv.classList.add('hidden');
            toggleBtn.textContent = '+';
        }
    }

    function searchHelp() {
        const query = helpSearchInput.value.toLowerCase();
        let found = false;
        helpSectionsData.forEach((section, index) => {
            const sectionText = section.title.toLowerCase() + " " + section.content.map(item => item.subtitle.toLowerCase() + " " + item.text.toLowerCase()).join(" ");
            if (sectionText.includes(query)) {
                if (!section.expanded) {
                    toggleSection(section, section.element); // Expand if collapsed
                }
                section.element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                showNotification(`Found in: ${section.title}`, "info");
                found = true;
            }
        });
        if (!found) {
            showNotification(`No results found for "${query}"`, "warning");
        }
    }

    searchBtn.addEventListener('click', searchHelp);
    helpSearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            searchHelp();
        }
    });

    printGuideBtn.addEventListener('click', async () => {
        if (!confirm("Do you want to generate a printable PDF of this guide?")) {
            return;
        }

        showNotification("Generating printable guide...", "info");

        try {
            // Create a temporary, hidden iframe to load the content for printing
            const printFrame = document.createElement('iframe');
            document.body.appendChild(printFrame);
            printFrame.style.display = 'none'; // Hide the iframe

            const printDoc = printFrame.contentWindow.document;
            printDoc.open();
            printDoc.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Crop Disease Diagnosis Guide</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 20px; color: #333; }
                        h1 { font-size: 24px; text-align: center; margin-bottom: 20px; }
                        h2 { font-size: 20px; color: #6200EE; margin-top: 15px; margin-bottom: 5px; }
                        h3 { font-size: 16px; color: #444; margin-top: 10px; margin-bottom: 3px; }
                        p { font-size: 14px; line-height: 1.5; margin-bottom: 10px; white-space: pre-line;}
                        ul { list-style-type: disc; margin-left: 20px; margin-bottom: 10px; }
                        li { margin-bottom: 5px; }
                        .section { border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
                    </style>
                </head>
                <body>
                    <h1>Crop Disease Diagnosis Guide</h1>
                    <p style="text-align: center;">Generated on: ${new Date().toLocaleString()}</p>
                    <hr style="margin: 20px 0;">
            `);

            helpSectionsData.forEach(section => {
                printDoc.write(`<div class="section">`);
                printDoc.write(`<h2>${section.title}</h2>`);
                section.content.forEach(item => {
                    printDoc.write(`<h3>${item.subtitle}</h3>`);
                    printDoc.write(`<p>${item.text.replace(/\n/g, '<br>')}</p>`); // Preserve newlines
                });
                printDoc.write(`</div>`);
            });

            printDoc.write(`</body></html>`);
            printDoc.close();

            // Wait for content to render, then print
            printFrame.contentWindow.onload = () => {
                printFrame.contentWindow.focus();
                printFrame.contentWindow.print();
                document.body.removeChild(printFrame); // Clean up iframe
                showNotification("Guide opened for printing. Use your browser's print dialog.", "success", 5000);
            };

        } catch (error) {
            console.error("Error generating printable guide:", error);
            showNotification("Failed to generate printable guide.", "error");
        }
    });

    // Initial build of content on page load
    document.addEventListener('DOMContentLoaded', buildHelpContent);
</script>
{% endblock %}