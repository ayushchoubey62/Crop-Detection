{% extends "base.html" %}
{% block content %}
<div class="container mx-auto p-4 diagnosis-bg rounded-lg shadow-xl">
    <h1 class="text-3xl font-bold mb-6 diagnosis-title">Diagnosis History</h1>

    <!-- Filter and Sort Controls -->
    <div class="card p-4 mb-6 rounded-lg shadow-md flex flex-wrap items-center gap-4">
        <h2 class="text-xl font-semibold section-title">Controls</h2>
        <div class="flex items-center space-x-2 ml-auto">
            <label for="sortBy" class="text-gray-700 dark:text-gray-300">Sort by:</label>
            <select id="sortBy" class="input-field p-2 rounded-md">
                <option value="recent">Most Recent</option>
                <option value="oldest">Oldest First</option>
                <option value="highest_confidence">Highest Confidence</option>
                <option value="lowest_confidence">Lowest Confidence</option>
            </select>
        </div>
        <div class="flex items-center space-x-2">
            <label for="filterByCrop" class="text-gray-700 dark:text-gray-300">Filter by crop:</label>
            <select id="filterByCrop" class="input-field p-2 rounded-md">
                <option value="all">All Crops</option>
                {% for label in class_labels.keys() %}
                    {% set crop_type = label.split('_')[0] %}
                    <option value="{{ crop_type | lower }}">{{ crop_type }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- History List -->
        <div class="md:col-span-1 card p-4 rounded-lg shadow-md overflow-y-auto max-h-[600px]">
            <h2 class="text-xl font-semibold mb-4 section-title">Recent Diagnoses</h2>
            <ul id="historyList" class="space-y-2">
                {% if history %}
                    {% for item in history %}
                        <li class="history-item p-3 rounded-md cursor-pointer hover:bg-primary/20 transition-colors duration-200"
                            data-filename="{{ item.image_path.split('/')[-1] if item.image_path else '' }}"
                            data-timestamp="{{ item.timestamp }}"
                            data-crop="{{ item.diagnosis.crop_type | lower }}"
                            data-confidence="{{ item.diagnosis.confidence | replace('%', '') | float }}"
                        >
                            <p class="font-semibold text-lg">{{ item.diagnosis.crop_type }} - {{ item.diagnosis.disease_name }}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">{{ item.timestamp }}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Confidence: {{ item.diagnosis.confidence }}</p>
                        </li>
                    {% endfor %}
                {% else %}
                    <p class="text-gray-500 dark:text-gray-400">No diagnosis history yet.</p>
                {% endif %}
            </ul>
        </div>

        <!-- Diagnosis Details -->
        <div class="md:col-span-2 card p-4 rounded-lg shadow-md flex flex-col">
            <h2 class="text-xl font-semibold mb-4 section-title">Diagnosis Details</h2>
            <div id="detailContent" class="flex-grow">
                <div id="detailImageContainer" class="mb-4 flex justify-center items-center bg-gray-100 dark:bg-gray-800 rounded-md p-2" style="min-height: 200px;">
                    <img id="detailImage" src="" alt="Diagnosis Image" class="max-w-full max-h-64 object-contain rounded-md" style="display: none;">
                    <p id="noDetailImageText" class="text-gray-500 dark:text-gray-400">Select an item to see details</p>
                </div>
                <div id="detailText" class="p-4 border rounded-md overflow-y-auto text-area-bg text-gray-800 dark:text-gray-200" style="min-height: 250px;">
                    <p>Select a diagnosis from the list to view its details.</p>
                </div>
            </div>
            <div class="flex flex-wrap justify-end gap-2 mt-4">
                <button id="viewImageBtn" class="btn-primary px-4 py-2 rounded-md" disabled>View Full Image</button>
                <button id="reDiagnoseBtn" class="btn-primary px-4 py-2 rounded-md" disabled>Re-diagnose</button>
                <button id="deleteSelectedBtn" class="btn-primary px-4 py-2 rounded-md" disabled>Delete Selected</button>
            </div>
        </div>
    </div>

    <!-- Global History Management Buttons -->
    <div class="flex flex-wrap justify-center gap-4 mt-6">
        <button id="exportAllHistoryBtn" class="btn-primary px-6 py-2 rounded-md">Export All History</button>
        <input type="file" id="importHistoryFile" accept=".json" class="hidden" onchange="handleImportHistory(event)">
        <button onclick="document.getElementById('importHistoryFile').click()" class="btn-primary px-6 py-2 rounded-md">Import History</button>
        <button id="clearAllHistoryBtn" class="btn-primary px-6 py-2 rounded-md">Clear All History</button>
        <a href="/" class="btn-primary px-6 py-2 rounded-md">Back to Home</a>
    </div>
</div>

<script>
    const historyList = document.getElementById('historyList');
    const detailImage = document.getElementById('detailImage');
    const noDetailImageText = document.getElementById('noDetailImageText');
    const detailText = document.getElementById('detailText');
    const viewImageBtn = document.getElementById('viewImageBtn');
    const reDiagnoseBtn = document.getElementById('reDiagnoseBtn');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const sortBySelect = document.getElementById('sortBy');
    const filterByCropSelect = document.getElementById('filterByCrop');
    const exportAllHistoryBtn = document.getElementById('exportAllHistoryBtn');
    const clearAllHistoryBtn = document.getElementById('clearAllHistoryBtn');

    let selectedHistoryItem = null; // Stores the full data of the selected item

    // Event Listeners for sorting and filtering
    sortBySelect.addEventListener('change', refreshHistoryDisplay);
    filterByCropSelect.addEventListener('change', refreshHistoryDisplay);

    historyList.addEventListener('click', async (event) => {
        const listItem = event.target.closest('.history-item');
        if (listItem) {
            // Remove 'selected' class from previously selected item
            const currentSelected = historyList.querySelector('.history-item.bg-primary\\/30');
            if (currentSelected) {
                currentSelected.classList.remove('bg-primary/30', 'dark:bg-primary/40');
            }
            // Add 'selected' class to the clicked item
            listItem.classList.add('bg-primary/30', 'dark:bg-primary/40');

            const filename = listItem.dataset.filename;
            await fetchHistoryDetails(filename);
        }
    });

    async function fetchHistoryDetails(filename) {
        try {
            const response = await fetch(`/get_history_details/${filename}`);
            const data = await response.json();

            if (data.success) {
                selectedHistoryItem = data; // Store full data
                displayDetails(data);
                enableDetailButtons(data);
            } else {
                showNotification(`Error fetching details: ${data.error}`, 'error');
                clearDetailDisplay();
            }
        } catch (error) {
            console.error("Error fetching history details:", error);
            showNotification("Failed to load history details.", "error");
            clearDetailDisplay();
        }
    }

    function displayDetails(data) {
        const diagnosis = data.details;
        const info = data.info;
        const treatments = data.treatment_suggestions;
        const imageUrl = data.image_url;

        // Display image
        if (imageUrl) {
            detailImage.src = imageUrl;
            detailImage.style.display = 'block';
            noDetailImageText.style.display = 'none';
        } else {
            detailImage.src = '';
            detailImage.style.display = 'none';
            noDetailImageText.style.display = 'block';
        }

        // Display text details
        let html = `
            <h3 class="text-xl font-bold mb-2 text-primary">DIAGNOSIS DETAILS</h3>
            <p><strong>Crop Type:</strong> ${diagnosis.crop_type}</p>
            <p><strong>Disease:</strong> ${diagnosis.disease_name} ${diagnosis.disease_name.toLowerCase().includes('healthy') ? '✅' : '⚠️'}</p>
            <p><strong>Confidence:</strong> <span class="${getConfidenceColorClass(diagnosis.confidence)}">${diagnosis.confidence}</span></p>
            <p><strong>Date:</strong> ${selectedHistoryItem.timestamp}</p>
            <p><strong>Image File:</strong> ${selectedHistoryItem.image_path ? selectedHistoryItem.image_path.split('/').pop() : 'N/A'}</p>
            <hr class="my-4 border-gray-300 dark:border-gray-600">

            <h3 class="text-xl font-bold mb-2 text-primary">Disease Information</h3>
            <p><strong>Description:</strong> ${info.description}</p>
            <p class="mt-2"><strong>Symptoms:</strong> ${info.symptoms}</p>
            <hr class="my-4 border-gray-300 dark:border-gray-600">

            <h3 class="text-xl font-bold mb-2 text-primary">Treatment Suggestions</h3>
            <ul class="list-disc pl-5">
        `;
        if (treatments && treatments.length > 0) {
            treatments.forEach(s => {
                html += `<li>${s}</li>`;
            });
        } else {
            html += `<li>No specific treatment suggestions available.</li>`;
        }
        html += `</ul>`;

        detailText.innerHTML = html;
    }

    function getConfidenceColorClass(confidence) {
        const confVal = parseFloat(confidence.replace('%', ''));
        if (confVal > 75) return 'text-green-500 font-semibold';
        if (confVal > 50) return 'text-orange-500 font-semibold';
        return 'text-red-500 font-semibold';
    }

    function enableDetailButtons(data) {
        viewImageBtn.disabled = !(data.image_url);
        reDiagnoseBtn.disabled = !(data.image_url);
        deleteSelectedBtn.disabled = false;
    }

    function clearDetailDisplay() {
        selectedHistoryItem = null;
        detailImage.src = '';
        detailImage.style.display = 'none';
        noDetailImageText.style.display = 'block';
        detailText.innerHTML = '<p>Select a diagnosis from the list to view its details.</p>';
        viewImageBtn.disabled = true;
        reDiagnoseBtn.disabled = true;
        deleteSelectedBtn.disabled = true;
    }

    viewImageBtn.addEventListener('click', () => {
        if (selectedHistoryItem && selectedHistoryItem.image_url) {
            window.open(selectedHistoryItem.image_url, '_blank');
            showNotification("Opening full image.", "info");
        } else {
            showNotification("No image available for this record.", "warning");
        }
    });

    reDiagnoseBtn.addEventListener('click', () => {
        if (selectedHistoryItem && selectedHistoryItem.image_url) {
            // Redirect to diagnose page with image filename as query parameter
            const filename = selectedHistoryItem.image_url.split('/').pop();
            window.location.href = `/diagnose?image=${filename}`;
        } else {
            showNotification("No image available to re-diagnose.", "warning");
        }
    });

    deleteSelectedBtn.addEventListener('click', async () => {
        if (selectedHistoryItem) {
            if (confirm("Are you sure you want to delete this diagnosis record?")) {
                try {
                    const filename = selectedHistoryItem.image_url.split('/').pop();
                    const response = await fetch(`/delete_history_item/${filename}`, { method: 'POST' });
                    const data = await response.json();
                    if (data.success) {
                        showNotification("Record deleted successfully.", "success");
                        refreshHistoryDisplay();
                        clearDetailDisplay();
                    } else {
                        showNotification(`Error deleting record: ${data.message}`, 'error');
                    }
                } catch (error) {
                    console.error("Error deleting history item:", error);
                    showNotification("Failed to delete record.", "error");
                }
            }
        } else {
            showNotification("No item selected to delete.", "warning");
        }
    });

    clearAllHistoryBtn.addEventListener('click', async () => {
        if (confirm("Are you sure you want to clear ALL diagnosis history? This action cannot be undone.")) {
            try {
                const response = await fetch('/clear_all_history', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showNotification("All history cleared successfully.", "success");
                    refreshHistoryDisplay();
                    clearDetailDisplay();
                } else {
                    showNotification(`Error clearing history: ${data.message}`, 'error');
                }
            } catch (error) {
                    console.error("Error clearing all history:", error);
                    showNotification("Failed to clear all history.", "error");
                }
            }
        });

    exportAllHistoryBtn.addEventListener('click', async () => {
        try {
            const response = await fetch('/export_all_history');
            if (response.ok) {
                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'crop_diagnosis_history.json';
                if (contentDisposition && contentDisposition.indexOf('filename=') !== -1) {
                    filename = contentDisposition.split('filename=')[1].split(';')[0].replace(/"/g, '');
                }
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showNotification("All history exported successfully!", "success");
            } else {
                const errorData = await response.json();
                showNotification(`Failed to export history: ${errorData.error}`, "error");
            }
        } catch (error) {
            console.error("Error exporting all history:", error);
            showNotification("An error occurred while exporting history.", "error");
        }
    });

    function handleImportHistory(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (confirm("Do you want to append this history to your existing history? Click Cancel to overwrite existing history.")) {
            importHistory(file, false); // Append
        } else {
            importHistory(file, true); // Overwrite
        }
    }

    async function importHistory(file, overwrite) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('overwrite', overwrite);

        try {
            const response = await fetch('/import_history', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showNotification(data.message, "success");
                refreshHistoryDisplay();
                clearDetailDisplay();
            } else {
                showNotification(`Import failed: ${data.error}`, "error");
            }
        } catch (error) {
            console.error("Error importing history:", error);
            showNotification("An error occurred during import.", "error");
        }
    }

    function refreshHistoryDisplay() {
        const historyItems = Array.from(document.querySelectorAll('#historyList .history-item'));
        
        // Filter
        const filterCrop = filterByCropSelect.value;
        historyItems.forEach(item => {
            const itemCrop = item.dataset.crop;
            if (filterCrop === 'all' || itemCrop === filterCrop) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });

        // Sort
        const sortBy = sortBySelect.value;
        const sortedItems = Array.from(historyList.children).filter(item => item.style.display !== 'none'); // Only sort visible items

        sortedItems.sort((a, b) => {
            if (sortBy === 'recent') {
                return new Date(b.dataset.timestamp) - new Date(a.dataset.timestamp);
            } else if (sortBy === 'oldest') {
                return new Date(a.dataset.timestamp) - new Date(b.dataset.timestamp);
            } else if (sortBy === 'highest_confidence') {
                return parseFloat(b.dataset.confidence) - parseFloat(a.dataset.confidence);
            } else if (sortBy === 'lowest_confidence') {
                return parseFloat(a.dataset.confidence) - parseFloat(b.dataset.confidence);
            }
            return 0;
        });

        historyList.innerHTML = ''; // Clear current list
        sortedItems.forEach(item => historyList.appendChild(item)); // Re-add sorted items
        
        if (historyList.children.length === 0) {
            historyList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No diagnosis history yet.</p>';
        }
    }

    // Initial refresh on page load
    document.addEventListener('DOMContentLoaded', refreshHistoryDisplay);
</script>
{% endblock %}